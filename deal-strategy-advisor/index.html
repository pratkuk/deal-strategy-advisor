<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Workspace</title>
    
    <!-- NEW Dropdown Fix v2 - More robust implementation -->
    <script src="js/dropdown-fix-v2.js"></script>
    
    <!-- Emergency Fix Script - Loads first to ensure it works even if other scripts fail -->
    <script src="js/emergency-fix.js"></script>
    
    <!-- Deal Test Controls Script - Replaces test deals with real ones -->
    <script src="js/deal-test-controls.js"></script>
    
    <!-- Dedicated fix for Select Deal dropdown -->
    <script src="js/select-deal-fix.js"></script>
    
    <!-- Workspace Tabs Fix - Ensures workspace tabs respond to clicks -->
    <script src="js/workspace-fix.js"></script>
    
    <!-- Dropdown Fix - Ensures dropdowns expand when clicked -->
    <script src="js/dropdown-fix.js"></script>
    
    <!-- Direct event handlers for critical functionality -->
    <script src="js/direct-handlers.js"></script>
    
    <!-- Critical CSS Fix: Force basic interactivity even if regular CSS is broken -->
    <style>
        /* Force pointer events to work on clickable elements */
        button, a, .tab, [class*="btn"], [role="button"], .dropdown, .select-deal-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Ensure modals and fixed elements don't block all interaction */
        .modal-backdrop:not(.visible) {
            display: none !important;
        }
        
        /* Make sure no invisible overlays are blocking clicks */
        body:before {
            content: none !important;
        }
        
        /* Ensure dropdowns can be clicked */
        .dropdown-content {
            z-index: 999 !important;
        }
        
        /* Fix for potential event bubbling issues */
        [data-tab], [data-deal], [data-dealtab] {
            pointer-events: auto !important;
        }
        
        /* Special fix for workspace tabs */
        .workspace-tabs .tab {
            position: relative;
            z-index: 100 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Ensure workspace content is visible when active */
        .workspace-content.active {
            display: block !important;
        }
        
        /* Force workspace content to be hidden when not active */
        .workspace-content:not(.active) {
            display: none !important;
        }
        
        /* Dropdown fixes */
        .dropdown {
            position: relative !important;
            display: inline-block !important;
        }
        
        .dropdown-content {
            display: none !important;
            position: absolute !important;
            background-color: #f9f9f9 !important;
            min-width: 160px !important;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2) !important;
            z-index: 9999 !important;
            border-radius: 4px !important;
        }
        
        /* Critical fix: When dropdown has show class, make it visible */
        .dropdown-content.show {
            display: block !important;
        }
        
        /* Ensure dropdown items are visible and clickable */
        .dropdown-content a {
            color: black !important;
            padding: 12px 16px !important;
            text-decoration: none !important;
            display: block !important;
            pointer-events: auto !important;
        }
        
        /* Hover effect for dropdown items */
        .dropdown-content a:hover {
            background-color: #f1f1f1 !important;
        }
        
        /* Override any hover behavior that might interfere with click handling */
        .dropdown:hover .dropdown-content:not(.show) {
            display: none !important;
        }
        
        /* FIXED: Agent dropdown expands UPWARD */
        .widget-mode-selector .dropdown-content.show {
            display: block !important;
            position: absolute !important;
            bottom: 100% !important; /* Position above button */
            left: 0 !important;
            z-index: 9999 !important;
            margin-bottom: 5px !important;
        }
        
        /* FIXED: Deal dropdown ALSO expands UPWARD (changed from downward) */
        .no-deal-state .dropdown-content.show {
            display: block !important;
            position: absolute !important;
            bottom: 100% !important; /* Changed from top to bottom - now positions above button */
            left: 0 !important;
            z-index: 9999 !important;
            margin-bottom: 5px !important; /* Changed from margin-top */
            min-width: 200px !important;
        }
    </style>
    
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/widget-dropdowns.css">
    <link rel="stylesheet" href="css/critical-dropdown-fix.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Main Workspace Tabs -->
    <div class="workspace-tabs">
        <div class="tab active" data-tab="hubspot">
            <img src="https://www.hubspot.com/hubfs/HubSpot_Logos/HubSpot-Inversed-Favicon.png" alt="Hubspot">
            <span>Hubspot</span>
        </div>
        <div class="tab" data-tab="gmail">
            <img src="https://www.google.com/gmail/about/static/images/logo-gmail.png?cache=1adba63" alt="Gmail">
            <span>Gmail</span>
        </div>
        <div class="tab" data-tab="calendar">
            <img src="https://www.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_31_2x.png" alt="Calendar">
            <span>Calendar</span>
        </div>
        <div class="tab" data-tab="dealhub">
            <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='white' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z'/><path fill='white' d='M12 12l-5-5h10z'/></svg>" alt="Dealhub">
            <span>Dealhub</span>
        </div>
    </div>

    <!-- Hubspot Interface -->
    <div class="workspace-content active" id="hubspot-content">
        <nav class="hubspot-nav">
            <div class="nav-left">
                <img src="https://www.hubspot.com/hubfs/HubSpot_Logos/HubSpot-Inversed-Favicon.png" alt="Hubspot" class="hubspot-logo">
                <div class="nav-menu">
                    <a href="#" class="active">Sales</a>
                    <a href="#">Marketing</a>
                    <a href="#">Service</a>
                    <a href="#">Operations</a>
                </div>
            </div>
            <div class="nav-right">
                <button class="view-deals">View Deals</button>
            </div>
        </nav>

        <div class="pipeline-header">
            <div class="header-left">
                <h2>Deals</h2>
                <div class="view-controls">
                    <button class="view-btn active">Board</button>
                    <button class="view-btn">Table</button>
                </div>
                <select class="pipeline-select">
                    <option>Sales Pipeline</option>
                </select>
            </div>
            <div class="header-right">
                <button class="create-btn">Create deal</button>
            </div>
        </div>

        <div class="pipeline-board"></div>
        <div class="deal-control-container"></div>
    </div>

    <!-- Gmail Interface -->
    <div class="workspace-content" id="gmail-content">
        <div class="email-interface">
            <div class="email-sidebar">
                <div class="compose-btn">
                    <button>Compose</button>
                </div>
                <div class="email-folders">
                    <div class="folder active">Inbox</div>
                    <div class="folder">Sent</div>
                    <div class="folder">Drafts</div>
                    <div class="folder">Deal Updates</div>
                </div>
            </div>
            <div class="email-list">
                <div class="email-list-header">
                    <div class="email-controls">
                        <input type="checkbox">
                        <button>Archive</button>
                        <button>Delete</button>
                    </div>
                    <div class="email-sort">
                        <select>
                            <option>Newest first</option>
                            <option>Oldest first</option>
                        </select>
                    </div>
                </div>
                <div class="email-items">
                    <!-- Email items will be populated here -->
                </div>
            </div>
            <div class="email-preview">
                <div class="email-preview-content">
                    <!-- Email preview will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Interface -->
    <div class="workspace-content" id="calendar-content">
        <div class="calendar-interface">
            <div class="calendar-sidebar">
                <div class="calendar-navigation">
                    <button class="prev-month">←</button>
                    <h2>March 2024</h2>
                    <button class="next-month">→</button>
                </div>
                <div class="calendar-filters">
                    <label>
                        <input type="checkbox" checked>
                        Deal Meetings
                    </label>
                    <label>
                        <input type="checkbox" checked>
                        Internal Meetings
                    </label>
                    <label>
                        <input type="checkbox" checked>
                        Customer Calls
                    </label>
                </div>
                <div class="quick-add">
                    <button>+ Add Event</button>
                </div>
            </div>
            <div class="calendar-main">
                <div class="calendar-header">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                </div>
                <div class="calendar-grid">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
            <div class="event-preview">
                <div class="event-actions">
                    <button>Edit</button>
                    <button>Delete</button>
                </div>
                <div class="event-details">
                    <!-- Event details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Dealhub Interface -->
    <div class="workspace-content" id="dealhub-content">
        <div class="dealhub-interface">
            <div class="proposal-items">
                <!-- Proposal items will be populated here -->
            </div>
            <div class="proposal-preview">
                <div class="preview-header">
                    <h2>Proposal Preview</h2>
                    <div class="preview-actions">
                        <button class="edit-btn">Edit</button>
                        <button class="send-btn">Send</button>
                        <button class="download-btn">Download</button>
                    </div>
                </div>
                <div class="preview-content">
                    <!-- Preview content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Deal Advisor Widget -->
    <div id="deal-chat-widget" class="widget-collapsed">
        <div class="widget-header">
            <div class="drag-handle">
                <span class="drag-icon">⋮⋮</span>
                <span class="header-title">Deal Advisor</span>
            </div>
            <div class="widget-controls">
                <button class="control-btn collapse-btn" title="Collapse">−</button>
                <button class="control-btn expand-btn" title="Expand">□</button>
                <button class="control-btn expand-plus-btn" title="Show Deal Details">☰</button>
            </div>
        </div>
        
        <div class="widget-content">
            <!-- Hidden Tab Navigation (Kept for JS compatibility) -->
            <div class="widget-tabs" style="display: none;">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="agent">Chat</button>
                    <button class="tab-btn" data-tab="ask">Composer</button>
                    <button class="tab-btn" data-tab="tasks">Coaching</button>
                </div>
            </div>
            
            <!-- Two-pane layout container -->
            <div class="panes-container">
                <!-- Left pane: Chat area -->
                <div class="chat-pane">
                    <div class="tab-content chat-tab active">
                        <div class="chat-section">
                            <!-- Chat messages area - expanded to fill available space -->
                            <div class="chat-messages">
                                <div class="message system welcome-message no-deal-message active">
                                    How can I help you today? Add context to get started with a deal.
                                </div>
                                <div class="message system welcome-message deal-message">
                                    How can I help you with <span class="deal-name"></span>?
                                </div>
                            </div>
                            
                            <!-- Deal Context and Mode Selection in a single row -->
                            <div class="controls-bar">
                                <!-- Deal Context -->
                                <div class="deal-context-bar">
                                    <div class="no-deal-state active">
                                        <span class="no-deal-label">No deal selected</span>
                                        <div class="dropdown">
                                            <button class="select-deal-btn">Select Deal</button>
                                            <div class="dropdown-content">
                                                <a href="#" data-deal="deal-1">Acme Corp - $50,000</a>
                                                <a href="#" data-deal="deal-2">TechStar Inc - $75,000</a>
                                                <a href="#" data-deal="deal-3">Global Systems - $120,000</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="active-deal-state">
                                        <div class="deal-info">
                                            <span class="active-deal-name"></span>
                                            <span class="deal-stage-pill"></span>
                                        </div>
                                        <div class="deal-actions">
                                            <button class="switch-deal-btn" title="Switch Deal">↓</button>
                                            <button class="clear-deal-btn" title="Clear Deal Context">×</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mode/Tab Selector -->
                                <div class="widget-mode-selector">
                                    <div class="dropdown">
                                        <button class="mode-selector-btn">
                                            <span class="current-mode">Agent</span>
                                            <span class="dropdown-arrow">▼</span>
                                        </button>
                                        <div class="dropdown-content">
                                            <a href="#" data-tab="agent" class="active">Chat</a>
                                            <a href="#" data-tab="ask">Composer</a>
                                            <a href="#" data-tab="tasks">Coaching</a>
                                        </div>
                                    </div>
                                    <!-- Action buttons -->
                                    <div class="mode-action-buttons">
                                        <button class="mode-action-btn" title="Edit">
                                            <span class="action-icon">✎</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat input at the bottom -->
                            <div class="chat-input-container">
                                <button id="showContextMenuBtn" title="Show Context Menu" class="context-menu-left-btn">@</button>
                                <input type="text" id="chatInput" class="chat-input" placeholder="Type a message or @ to mention deal context...">
                                <button id="fileUploadBtn" title="Upload File" class="file-upload-btn-chat">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                                </button>
                                <button class="send-btn">→</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right pane: Deal content area -->
                <div class="deal-content-pane">
                    <div class="deal-content-header">
                        <h3>Deal Details</h3>
                    </div>
                    <div class="deal-content-tabs">
                        <button class="deal-tab-btn active" data-dealtab="overview">Overview</button>
                        <button class="deal-tab-btn" data-dealtab="files">Files</button>
                        <button class="deal-tab-btn" data-dealtab="history">History</button>
                    </div>
                    <div class="deal-content-body">
                        <!-- Overview Tab -->
                        <div class="deal-tab-content overview-tab active">
                            <div class="no-deal-selected active">
                                <p>Select a deal to see details</p>
                            </div>
                            <div class="deal-overview">
                                <div class="deal-section">
                                    <h4>Deal Information <button class="edit-deal-btn" title="Edit Deal Information"><span class="edit-icon">✎</span></button></h4>
                                    <div class="deal-info-view">
                                        <div class="deal-info-grid">
                                            <div class="info-item">
                                                <span class="info-label">Company:</span>
                                                <span class="info-value company-name">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Value:</span>
                                                <span class="info-value deal-value">-</span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Stage:</span>
                                                <span class="info-value">
                                                    <span class="deal-stage-indicator"></span>
                                                    <span class="deal-stage">-</span>
                                                </span>
                                            </div>
                                            <div class="info-item">
                                                <span class="info-label">Close Date:</span>
                                                <span class="info-value close-date">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="deal-info-edit">
                                        <div class="deal-edit-form">
                                            <div class="form-group">
                                                <label for="edit-company">Company:</label>
                                                <input type="text" id="edit-company" class="edit-company">
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-value">Value:</label>
                                                <input type="text" id="edit-value" class="edit-value">
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-stage">Stage:</label>
                                                <select id="edit-stage" class="edit-stage">
                                                    <option value="Discovery">Discovery</option>
                                                    <option value="Qualification">Qualification</option>
                                                    <option value="Proposal">Proposal</option>
                                                    <option value="Negotiation">Negotiation</option>
                                                    <option value="Closed Won">Closed Won</option>
                                                    <option value="Closed Lost">Closed Lost</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="edit-date">Close Date:</label>
                                                <input type="date" id="edit-date" class="edit-date">
                                            </div>
                                            <div class="edit-actions">
                                                <button class="cancel-btn">Cancel</button>
                                                <button class="save-btn">Save</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="deal-section">
                                    <h4>Key Contacts</h4>
                                    <div class="contacts-list">
                                        <p class="no-contacts-message">No contacts added</p>
                                    </div>
                                </div>
                                <div class="deal-section">
                                    <h4>Notes</h4>
                                    <div class="deal-notes">
                                        <p class="no-notes-message">No notes added</p>
                                        <button class="add-note-btn">+ Add Note</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Files Tab -->
                        <div class="deal-tab-content files-tab">
                            <div class="no-deal-selected active">
                                <p>Select a deal to see files</p>
                            </div>
                            <div class="deal-files">
                                <div class="files-list-container">
                                    <div class="files-header">
                                        <h4>Deal Documents</h4>
                                        <button class="upload-file-btn">+ Upload</button>
                                    </div>
                                    <div class="files-list">
                                        <p class="no-files-message">No files uploaded</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- History Tab -->
                        <div class="deal-tab-content history-tab">
                            <div class="no-deal-selected active">
                                <p>Select a deal to see history</p>
                            </div>
                            <div class="deal-history">
                                <div class="timeline-container">
                                    <h4>Deal Timeline</h4>
                                    <div class="timeline-items">
                                        <p class="no-history-message">No history available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context menu modal - shared across all tabs -->
    <div id="contextModalBackdrop" class="modal-backdrop"></div>
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-header-bar">
            <div class="context-menu-title">Context References</div>
            <button id="closeContextMenu" class="close-context-menu">×</button>
        </div>
        <div class="context-menu-content">
            <!-- Context menu items will be populated dynamically -->
        </div>
    </div>

    <!-- Test mode indicator -->
    <div id="test-mode-indicator" style="position: fixed; top: 0; right: 0; background-color: #f44336; color: white; padding: 5px 10px; font-size: 12px; z-index: 9999;">
        TESTING MODE
    </div>

    <!-- Scripts -->
    <script src="js/dealData.js"></script>
    <script src="js/dealContent.js"></script>
    <script src="js/chatWidget.js"></script>
    <script src="js/main.js"></script>
    <script src="js/test.js"></script>
    
    <!-- Recovery script to handle page freezes -->
    <script src="js/recovery.js"></script>
</body>
</html> 